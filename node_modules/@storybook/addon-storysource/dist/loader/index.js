'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _loaderUtils = require('loader-utils');

var _injectDecorator = require('./inject-decorator');

var _injectDecorator2 = _interopRequireDefault(_injectDecorator);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ADD_DECORATOR_STATEMENT = '.addDecorator(withStorySource(__STORY__, __ADDS_MAP__))';

function transform(source) {
  var options = (0, _loaderUtils.getOptions)(this) || {};
  var result = (0, _injectDecorator2.default)(source, ADD_DECORATOR_STATEMENT, options);

  if (!result.changed) {
    return source;
  }

  var sourceJson = (0, _stringify2.default)(result.storySource).replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029');

  var addsMap = (0, _stringify2.default)(result.addsMap);

  return '\n  var withStorySource = require(\'@storybook/addon-storysource\').withStorySource;\n  var __STORY__ = ' + sourceJson + ';\n  var __ADDS_MAP__ = ' + addsMap + ';\n  \n  ' + result.source + '\n  ';
}

exports.default = transform;